* WRITE A RISCV ASSEMBLER

** INSTRUCTION ENCODER

#+BEGIN_SRC forth
  U-TYPE ( IMM RD OPCDOE -- INST )
  J-TYPE ( IMM RD OPCODE -- INST )
  I-TYPE ( IMM RS1 RD FUNCT3 OPCODE -- INST )
  S-TYPE ( IMM RS2 RS1 FUNCT3 OPCODE -- INST )
  B-TYPE ( IMM RS2 RS1 FUNCT3 OPCODE -- INST )
  R-TYPE ( FUNCT7 RS2 RS1 FUNCT3 RD OPCODE -- INST )
#+END_SRC

** INSTRUCTION

#+BEGIN_SRC forth
  : LUI, ( IMM RD -- ) $37 U-TYPE L, ;
#+END_SRC

** INSTRCUTION DECODER

#+BEGIN_SRC forth
  DIS-U-TYPE ( INST -- IMM RD OPCDOE )
  DIS-J-TYPE ( INST -- IMM RD OPCODE )
  DIS-I-TYPE ( INST -- IMM RS1 RD FUNCT3 OPCODE )
  DIS-S-TYPE ( INST -- IMM RS2 RS1 FUNCT3 OPCODE )
  DIS-B-TYPE ( INST -- IMM RS2 RS1 FUNCT3 OPCODE )
  DIS-R-TYPE ( INST -- FUNCT7 RS2 RS1 FUNCT3 RD OPCODE )
#+END_SRC

** HOW TO TEST

USE INSTRUCTION ENCODER GENERATE DATA, THEN USE GNU GAS GENERATE TEST RESULT, COMPARE OUTPUT

USE INSTRUCTION ENCODER GENERATE DATA, THEN USE INSTRUCTION DECODER DEOCDE IT, COMPARE INPUT

** GAS

I USE GAS TO GENERATE TEST PATTERN, BUT GAS HAVE SOME OPTIMIZE FOR BRANCH INSTRUCTION:

#+BEGIN_SRC asm
  	beq x0, x0, 0
#+END_SRC

WILL GENERATE:

#+BEGIN_SRC
  f4:   00001463                bnez    zero,fc <.text+0xfc>
  f8:   0000006f                j       f8 <.text+0xf8>
#+END_SRC

SO I SWITCH TO 'llvm-mc' GENERATE SINGLE BRANCH INSTRUCTION

** LLVM-MC

COMMAND:

#+BEGIN_SRC shell
  llvm-mc -triple=riscv32 -filetype=obj test.S -o a.out
#+END_SRC

** FAR CALL

** J TYPE ENCODING

#+BEGIN_SRC text
  11111111111111110000000000000000
  FEDCBA9876543210FEDCBA9876543210
  10000000000011110000000000000000
  4A987654321B3210FEDC432106543210
  O                   R    O
  F                   D    P
  F                        C
  S                        O
  E                        D
  T                        E



#+END_SRC

** CJ TYPE ENCODING

#+BEGIN_SRC text
  FEDCBA9876543210
  210B498A67321510
  F  O          O
  U  F          P
  N  F          C
  C  S          O
  T  E          D
  3  T          E
#+END_SRC


** CB TYPE ENCODING

#+BEGIN_SRC text
  FEDCBA9876543210
  2108432107621510
  F  O  R  O    O
  U  F  S  F    P
  N  F  1  F    C
  C  S     S    O
  T  E     E    D
  3  T     T    E
#+END_SRC
